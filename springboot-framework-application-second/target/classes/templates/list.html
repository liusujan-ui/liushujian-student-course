<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>用户列表</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/css/bootstrap.min.css">
</head>
<body>
<div class="container">
    <h2>用户列表</h2>

    <!-- 添加用户按钮 -->
    <div class="mb-3">
        <button class="btn btn-primary" data-toggle="modal" data-target="#addUserModal">添加用户</button>
    </div>

    <!-- 用户列表表格 -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>密码</th>
                <th>姓名</th>
                <th>性别</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="user : ${users}">
                <td th:text="${user.id}"></td>
                <td th:text="${user.username}"></td>
                <td th:text="${user.password}"></td>
                <td th:text="${user.name}"></td>
                <td th:text="${user.userSex}"></td>
                <td>
                    <!-- 修改按钮 -->
                    <button class="btn btn-sm btn-warning"
                            data-toggle="modal"
                            data-target="#editUserModal"
                            onclick="loadUserForEdit(/*[[${user.id}]]*/)">修改</button>
                    <!-- 删除按钮 -->
                    <button class="btn btn-sm btn-danger delete-btn"
                            th:data-user-id="${user.id}">删除</button>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 添加用户模态框 -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">添加用户</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addUserForm" action="/user/add" method="post">
                    <div class="form-group">
                        <label for="addId">ID:</label>
                        <input type="number" class="form-control" id="addId" name="id" required>
                    </div>
                    <div class="form-group">
                        <label for="addUsername">用户名:</label>
                        <input type="text" class="form-control" id="addUsername" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="addPassword">密码:</label>
                        <input type="password" class="form-control" id="addPassword" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="addName">姓名:</label>
                        <input type="text" class="form-control" id="addName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="addUserSex">性别:</label>
                        <select class="form-control" id="addUserSex" name="userSex" required>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitAddForm()">添加</button>
            </div>
        </div>
    </div>
</div>

<!-- 修改用户模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">修改用户</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm" action="/user/update" method="post">
                    <input type="hidden" id="editId" name="id">
                    <div class="form-group">
                        <label for="editUsername">用户名:</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="editPassword">密码:</label>
                        <input type="password" class="form-control" id="editPassword" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="editName">姓名:</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="editUserSex">性别:</label>
                        <select class="form-control" id="editUserSex" name="userSex" required>
                            <option value="男">男</option>
                            <option value="女">女</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitEditForm()">保存</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/popper.js/1.12.5/umd/popper.min.js"></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.0/js/bootstrap.min.js"></script>
<script>
    // 加载用户数据到修改模态框
    function loadUserForEdit(userId) {
        // 这里应该通过AJAX获取用户详细信息
        // 为简化演示，这里只设置ID
        document.getElementById('editId').value = userId;

        // 实际项目中应添加AJAX请求获取用户详情
        // $.get('/user/' + userId, function(data) {
        //     $('#editUsername').val(data.username);
        //     $('#editPassword').val(data.password);
        //     $('#editName').val(data.name);
        //     $('#editUserSex').val(data.userSex);
        // });
    }

    // 提交添加用户表单
    function submitAddForm() {
        $('#addUserForm').submit();
    }

    // 提交修改用户表单
    function submitEditForm() {
        $('#editUserForm').submit();
    }

        // 为所有删除按钮绑定事件
    // 使用事件委托处理删除按钮点击
    $(document).ready(function() {
        // 使用事件委托处理删除按钮点击
        $(document).on('click', '.delete-btn', function() {
            const userId = $(this).data('user-id');
            console.log('获取到的用户ID:', userId);
            alert(userId)
            if (!userId) {
                console.error('用户ID为空');
                alert('用户ID无效');
                return;
            }

            if (confirm('确定要删除这个用户吗？')) {
                $.ajax({
                    url: '/user/delete/' + userId,
                    type: 'POST',
                    data: {
                        _method: 'DELETE'
                    },
                    success: function(response) {
                        console.log('删除成功');
                        // 从页面移除该行
                        $(this).closest('tr').remove();
                        alert('删除成功！');
                    }.bind(this),
                    error: function(xhr, status, error) {
                        console.error('删除失败:', error);
                        alert('删除失败：' + error);
                    }
                });
            }
        });
    });

</script>
</body>
</html>
